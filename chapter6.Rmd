---
output: html_document
editor_options: 
  chunk_output_type: inline
---
# Chapter 6 Analysis of longitudinal data

Here, we intend to do the analysis of longitudinal data as in the textbook of Multivariate Analysis for the Behavioral Sciences (MABS) by Vehkalahti and
Everitt (2019) Chapter 8 and 9. The difference between this exercise and the original analysis in the textbook is that we swap the dataset, i.e. using the RATS data in the analyses of Chapter 8 of MABS and using the BPRS data in the analyses of Chapter 9 of MABS.

We use the following R packages: 

```{r, results="hide", message=FALSE, warning=FALSE, error=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```

## 6.1. Implement the analyses of Chapter 8 of MABS using the RATS data

We start with preparing the dataset which we have also conducted in the previous data wrangling exercise.

```{r}
# read the RATS data
RATS <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/rats.txt", header = TRUE, sep = '\t')
# Factor variables ID and Group in RATS data
RATS$ID <- factor(RATS$ID)
RATS$Group <- factor(RATS$Group)
# Convert to long form and add a Time variable to RATS
RATSL <- RATS %>%
  gather(key = WD, value = Weight, -ID, -Group) %>%
  mutate(Time = as.integer(substr(WD,3,4))) 
```

```{r}
# Check the dimensions of the data
dim(RATSL)

# Plot the RATSL data
ggplot(RATSL, aes(x = Time, y = Weight, group = ID)) +
  geom_line(aes(linetype = Group)) +
  scale_x_continuous(name = "Time (days)", breaks = seq(0, 60, 10)) +
  scale_y_continuous(name = "Weight (grams)") +
  theme(legend.position = "top")
```
\
In the RATS dataset, there are three kind of treatments that can bee seen from the plot above as group 1, group 2, and group three. The weight (in grams) of the rats is on y-axis plotted against time (in days) on x-axis.
\

### Figure 8.1 Individual response profiles by treatment group for the RATS data

We continue with plotting individual response profiles by group of treatments for the RATS data. A number of graphical displays including this one is useful in assessing longitudinal data which contains 'repeated measures'.

From the plot below, we can identify that there are substantial individual differences and variability seems to increase with time. Also, there appears significant gains in weight from treatment 1 to treatment 2 and 3 despite a possibility of existent outliers in the group of treatment 2.

```{r}
p1 <- ggplot(RATSL, aes(x = Time, y = Weight, linetype = ID))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ Group, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + theme(panel.grid.minor.y = element_blank())
p6 <- p5 + scale_y_continuous(limits = c(min(RATSL$Weight), max(RATSL$Weight)))
p6
```
\

### Figure 8.2 Individual response profiles for RATS data after standardization

Here, we standardize the weight by subtracting from its mean and then dividing by its standard deviation. Now, the trending variability over time looks gone, but the gains from treatment 1 to treatment 2 and 3 remain.

```{r}
# Standardize the scores:
RATSL <- RATSL %>%
  group_by(Time) %>%
  mutate( stdrats = (Weight - mean(Weight))/sd(Weight) ) %>%
  ungroup()
glimpse(RATSL)
p1 <- ggplot(RATSL, aes(x = Time, y = stdrats, linetype = ID))
p2 <- p1 + geom_line() + scale_linetype_manual(values = rep(1:10, times=4))
p3 <- p2 + facet_grid(. ~ Group, labeller = label_both)
p4 <- p3 + theme_bw() + theme(legend.position = "none")
p5 <- p4 + theme(panel.grid.minor.y = element_blank())
p6 <- p5 + scale_y_continuous(name = "standardized Weight")
p6
```
\

### Figure 8.3 Mean response profiles for the three treatment groups in the RATS data

Next, we perform summary measure analysis by plotting the mean response profiles for the three treatment groups in the RATS data. The plot essentially take the mean of individual responses forming one series of mean, so we can see its behavior overtime. As we can see from the plot below, it trends up overtime and we can see a significant gain in weight from treatment 1 to treatment 2 and 3.

```{r}
# Number of subjects (per group):
n <- 20
# Make a summary data:
RATSS <- RATSL %>%
  group_by(Group, Time) %>%
  summarise( mean=mean(Weight), se=sd(Weight)/sqrt(n) ) %>%
  ungroup()
glimpse(RATSS)
p1 <- ggplot(RATSS, aes(x = Time, y = mean, linetype = Group, shape = Group))
p2 <- p1 + geom_line() + scale_linetype_manual(values = c(1,2,3))
p3 <- p2 + geom_point(size=3) + scale_shape_manual(values = c(1,2,3))
p4 <- p3 + geom_errorbar(aes(ymin=mean-se, ymax=mean+se, linetype="1"), width=0.3)
p5 <- p4 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p6 <- p5 + theme(legend.position = c(0.8,0.5))
p7 <- p6 + scale_y_continuous(name = "mean(Weight) +/- se(Weight)")
p7
```
\

### Figure 8.4 Boxplots for the RATS data

Another summary measure analysis that we can do is by displaying boxplots. Basically, every single boxplot contains information of the lowest point, the highest point, the most populated points, and the mean, hence we can gather lots of information. From the boxplots below, we can see the same patterns as before, i.e. trending up variability overtime and significant gains in weight in treatment 2 and 3. One additional information that we can see are the outliers as displayed the black dots.

```{r}
p1 <- ggplot(RATSL, aes(x = factor(Time), y = Weight, fill = Group))
p2 <- p1 + geom_boxplot(position = position_dodge(width = 0.9))
p3 <- p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p4 <- p3 + theme(legend.position = c(0.8,0.4))
p5 <- p4 + scale_x_discrete(name = "Time")
# Black & White version:
#p6 <- p5 + scale_fill_grey(start = 0.5, end = 1)
p5
```
\

### Figure 8.5 Boxplots of mean summary measures for the three treatment groups in the RATS data

Next, rather than displaying the boxplots of weight against time, we here plot by group of treatments, i.e. 3 groups. As before, we see the significant gains in weight from treatment 1 to treatment 2 and 3.

```{r}
# Make a summary data of the post treatment Times (1-8)
RATSL8S <- RATSL %>%
  filter(Time > 0) %>%
  group_by(Group, ID) %>%
  summarise( mean=mean(Weight) ) %>%
  ungroup()
glimpse(RATSL8S)
p1 <- ggplot(RATSL8S, aes(x = Group, y = mean))
p2 <- p1 + geom_boxplot()
p3 <- p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p4 <- p3 + stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white")
p5 <- p4 + scale_y_continuous(name = "mean(Weight), days 1-8")
p5
```

\

### Figure 8.6 Boxplots of mean summary measures for the three treatment groups in the RATS data, without the outlier shown in Figure 8.5

Here, we remove the outlier in group 2, i.e. filter out the weight > 550 grams. The informations here is still the same as before, except the removed outlier in group 2.

```{r}
# Remove the outlier:
RATSL8S1 <- RATSL8S %>%
  filter(mean < 550)
glimpse(RATSL8S1)
p1 <- ggplot(RATSL8S1, aes(x = Group, y = mean))
p2 <- p1 + geom_boxplot()
p3 <- p2 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p4 <- p3 + stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white")
p5 <- p4 + scale_y_continuous(name = "mean(Weight), Times 1-8")
p5
```
\

### Table 8.3 Independent Samples t-test on the Mean Summary Measure for the RATS Data, Without the Outlier Shown in Figure 8.5

Next, we perform a formal test for a difference. We apply a pairwise _t_-test to assess any difference between the treatment groups. As we can see from the results below, we have significant evidence for group differences.


```{r, results="hide", message=FALSE, warning=FALSE, error=FALSE}
library(rstatix)
library(ggpubr)
```
```{r}
# Get summary statistic
RATSL8S1 %>%
  group_by(Group) %>%
  get_summary_stats(mean, type = "mean_sd")
# Pairwise t-tests
pwt <- RATSL8S1 %>%
  pairwise_t_test(mean ~ Group, p.adjust.method = "bonferroni")
pwt
```

### Table 8.4 Analysis of Covariance of the RATS Data with Baseline RATS and Treatment Groups as Covariates

Finally, here we perform analysis of covariance of the RATS Data with treatment 1 as baseline and treatment 2 and 3 as covariates. From the Analysis of Variance Table, we can see that we have a strong evidence of a treatment difference.

```{r}
# Add the baseline from the original data as a new variable to the summary data:
baseline <- RATS$WD1
RATSL8S2 <- RATSL8S %>%
  mutate(baseline)
# Fit the ANCOVA model and see the results:
fit <- lm(mean ~ baseline + Group, data = RATSL8S2)
summary(fit)
anova(fit)
```


## 6.2. Implement the analyses of Chapter 9 of MABS using the BPRS data

Prepare the dataset 

```{r}
# Read the BPRS data
BPRS <- read.table("https://raw.githubusercontent.com/KimmoVehkalahti/MABS/master/Examples/data/BPRS.txt", sep  =" ", header = T)
# Factor variables 'treatment' and 'subject' in BPRS data
BPRS$treatment <- factor(BPRS$treatment)
BPRS$subject <- factor(BPRS$subject)
# Convert the data sets to long form and add a week variable to BPRS
BPRSL <-  BPRS %>% gather(key = weeks, value = bprs, -treatment, -subject) 
BPRSL <-  BPRSL %>% mutate(week = as.integer(substr(weeks,5,5)))
```

\
### Table 9.1: Bprs Recorded Over a 9-Time Period

```{r, echo=TRUE}
BPRS <- within(BPRS, {
       subject <- factor(subject)
    treatment <- factor(treatment)
})
glimpse(BPRS)
```
\
### Table 9.2 Long Form of the Data

```{r, echo=TRUE}
glimpse(BPRSL)
head(BPRSL); tail(BPRSL)
```
\
### Figure 9.1 Plot of bprs against week for bprs data, ignoring the repeated-measures structure of the data but identifying the group to which each observation belongs

```{r, echo=TRUE}
p1 <- ggplot(BPRSL, aes(x = week, y = bprs, group = subject))
p2 <- p1 + geom_text(aes(label = treatment))
p3 <- p2 + scale_x_continuous(name = "Week", breaks = seq(0, 60, 10))
p4 <- p3 + scale_y_continuous(name = "bprs")
p5 <- p4 + theme_bw()
p6 <- p5 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p6
```
\
### Table 9.3 Fitting a Linear Regression Model to BPRS Data with bprs as Response Variable, and treatment and week as Explanatory Variables, and Ignoring the Repeated-Measures Structure of the Data

```{r, echo=TRUE}
BPRS_reg <- lm(bprs ~ week + treatment, data = BPRSL)
summary(BPRS_reg)
```
\
### Figure 9.2 Plot of individual bprs profiles

```{r, echo=TRUE}
#ERROR
#p1 <- ggplot(BPRSL, aes(x = week, y = bprs, group = subject))
#p2 <- p1 + geom_line(aes(linetype = treatment))
#p3 <- p2 + scale_x_continuous(name = "week", breaks = seq(0, 60, 10))
#p4 <- p3 + scale_y_continuous(name = "bprs")
#p5 <- p4 + theme_bw() + theme(legend.position = "top")
#p6 <- p5 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#p6

#Error: geom_path: If you are using dotted or dashed lines, colour, size and linetype must be constant over the line
#Run `rlang::last_error()` to see where the error occurred.
```
```{r}
# Draw the plot
ggplot(BPRSL, aes(x = week, y = bprs, linetype = subject)) +
  geom_line() +
  scale_linetype_manual(values = rep(1:10, times=4)) +
  facet_grid(. ~ treatment, labeller = label_both) +
  theme(legend.position = "none") + 
  scale_y_continuous(limits = c(min(BPRSL$bprs), max(BPRSL$bprs)))
```

\
### Figure 9.3 Scatterplot matrix of repeated measures in bprs data

```{r, echo=TRUE, fig.width=10, fig.height=10}
pairs(BPRS[, 3:11], cex = 0.7)
```
\
### Table 9.4 Fitting Random Intercept Model, with week and treatment as Explanatory Variables, to BPRS Data

```{r, results="hide", message=FALSE, warning=FALSE, error=FALSE}
library("lme4")
```

```{r, echo=TRUE}
BPRS_ref <- lmer(bprs ~ week + treatment + (1 | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref)

```
\
### Table 9.5 Fitting the Random Intercept and Slope Model, with week and treatment as Explanatory Variables, to BPRS Data

```{r, echo=TRUE}
BPRS_ref1 <- lmer(bprs ~ week + treatment + (week | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref1)
anova(BPRS_ref1, BPRS_ref)
```

\
### Table 9.6 Fitting the Random Intercept and Slope Model that Allows for a treatment × week Interaction to BPRS Data

```{r, echo=TRUE}
BPRS_ref2 <- lmer(bprs ~ week * treatment + (week | subject), data = BPRSL, REML = FALSE)
summary(BPRS_ref2)
anova(BPRS_ref1, BPRS_ref2)
```
\
### Figure 9.4 Fitted bprs profiles from the interaction model and observed bprs profiles

```{r, echo=TRUE, fig.width=3, fig.height=4}
Fitted <- fitted(BPRS_ref2)
BPRSL <- BPRSL %>% mutate(Fitted)
p1 <- ggplot(BPRSL, aes(x = week, y = bprs, group = subject))
p2 <- p1 + geom_line(aes(linetype = treatment))
p3 <- p2 + scale_x_continuous(name = "week", breaks = seq(0, 60, 20))
p4 <- p3 + scale_y_continuous(name = "bprs")
p5 <- p4 + theme_bw() + theme(legend.position = "right")
p6 <- p5 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p7 <- p6 + ggtitle("Observed")
graph1 <- p7
p1 <- ggplot(BPRSL, aes(x = week, y = bprs, group = subject))
p2 <- p1 + geom_line(aes(linetype = treatment))
p3 <- p2 + scale_x_continuous(name = "week", breaks = seq(0, 60, 20))
p4 <- p3 + scale_y_continuous(name = "bprs")
p5 <- p4 + theme_bw() + theme(legend.position = "right")
p6 <- p5 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p7 <- p6 + ggtitle("Fitted")
graph2 <- p7
#graph1; graph2

#Error: geom_path: If you are using dotted or dashed lines, colour, size and linetype must be constant over the line
#Run `rlang::last_error()` to see where the error occurred.
```





```{r}
# Create a summary data by treatment and subject with mean as the summary variable (ignoring baseline week 0).
BPRSL8S <- BPRSL %>%
  filter(week > 0) %>%
  group_by(treatment, subject) %>%
  summarise( mean=mean(bprs) ) %>%
  ungroup()

# Glimpse the data
glimpse(BPRSL8S)

# Draw a boxplot of the mean versus treatment
ggplot(BPRSL8S, aes(x = treatment, y = mean)) +
  geom_boxplot() +
  stat_summary(fun.y = "mean", geom = "point", shape=23, size=4, fill = "white") +
  scale_y_continuous(name = "mean(bprs), weeks 1-8")

# Create a new data by filtering the outlier and adjust the ggplot code the draw the plot again with the new data
BPRSL8S1 <- BPRSL8S %>%
  filter(mean < 60)
```





_This is the end of the report. That's all folks!_

```{r}
date()

```


